<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="center">
            <div id="box" class="fadein">
                <img src="logo.png" />
                <progress id="progressBar" max="100"></progress>
            </div>
        </div>
    </body>
    <script>

        let appSiteURL = '/otrs/index.pl'
        let appStatusProgressURL = 'progress.txt'
        let commentToCheckInitScreenServerRunning = '<!-- init-screen-redirection -->'
        let progressBar = document.getElementById("progressBar")
        let box = document.getElementById("box")
        let siteCheck = null;
        let progressBarCheck = null;
        let siteCheckTimeout = 2000; // ms
        let progressBarCheckTimeout = 1000; // ms
        let redirectTimeout = 500; // ms

        setProgressBar = (progress) => {
            progressBar.value = progress;

            if(progress == '') {
                indeterminateProgressBar();
            }
        }

        indeterminateProgressBar = (e) => {
            progressBar.removeAttribute('value');
            if(e) console.error(e);
        }

        testStatus = async (response) => {

            let statusOK
            let responseText = await response.text()
            try {
                statusOK = (response.status === 200) && (! responseText.match(new RegExp(`^${commentToCheckInitScreenServerRunning}`)) )
            } catch (e) {
                statusOK = false
                console.error(e)
            }

            return statusOK
        }

        loadSite = (doIt) => {
            if( doIt ) {
                setTimeout(() => {window.location.href = appSiteURL}, redirectTimeout);
            }
        }

        progressFetch = async () => { 
            await fetch(appStatusProgressURL, {cache: "no-cache"})
                .then(response => response.text())
                .then(setProgressBar)
                .catch(indeterminateProgressBar);
            if(progressBar.value != 100) {
                progressBarCheck = setTimeout(progressFetch, progressBarCheckTimeout);
            } else {
                setTimeout(indeterminateProgressBar, progressBarCheckTimeout + 3000)
            }
        }

        siteFetch = async () => { 
            await fetch(appSiteURL, {cache: "no-cache"})
                .then(testStatus)
                .then(loadSite)
                .catch(indeterminateProgressBar)
            siteCheck = setTimeout(siteFetch, siteCheckTimeout);
        }

        window.onload = function() {
            box.classList.add('fadeout');
            progressFetch();
            siteFetch();
        }

    </script>
</html>
